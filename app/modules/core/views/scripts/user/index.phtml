<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="<?php echo $this->baseUrl(); ?>/js/bui/skin/red/css/dpl.css">
    <link rel="stylesheet" href="<?php echo $this->baseUrl(); ?>/js/bui/skin/red/css/bui.css">
    <title>用户管理</title>
</head>
<body>
<div class="container">
    <div id="user-grid" style="margin:10px;"></div>
</div>
<div id="user-search" class="hide">
    <form id="search-form" class="form-horizontal">
        <div class="row">
            <div class="control-group span8">
                <label class="control-label">用户编号</label>
                <div class="controls">
                    <input type="text" name="authid" class="input-small control-text" data-messages="{regexp:'无效编号'}" data-rules="{regexp:/^$|^[0-9]{8}$/}"/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="control-group span8">
                <label class="control-label">帐号关键字</label>
                <div class="controls">
                    <input type="text" name="accountname" class="input-normal control-text" data-rules="{maxlength:20}"/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="control-group span8">
                <label class="control-label">所在用户组</label>
                <div class="controls">
                    <div id="roles">
                        <input type="hidden" id="roles-hide" value="" name="rolecode">
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="control-group span8">
                <label class="control-label">当前状态</label>
                <div class="controls">
                    <select name="validflag" class="input-normal">
                        <option value="Y">有效</option>
                        <option value="N">无效</option>
                    </select>
                </div>
            </div>
        </div>
    </form>
</div>
<!-- JS -->
<script type="text/javascript" src="<?php echo $this->baseUrl(); ?>/js/jquery/jquery-1.11.0.js"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl(); ?>/js/bui/skin/red/seed-min.js"></script>
<script type="text/javascript">
    var baseUrl="<?php echo $this->baseUrl(); ?>";
</script>
<script type="text/javascript">
    BUI.use(['bui/data','bui/grid','bui/overlay','bui/form','bui/select'],function(Data,Grid,Overlay,Form,Select){
        var searchForm,addForm,editForm,searchDialog,addDialog,editDialog,userStore,roleStore,columns,grid,roleSelect;
        roleStore=new Data.Store({
            url:baseUrl+'/core/role/list',
            proxy:{
                method:'post'
            },
            params:{
                valid:true
            },
            autoLoad:true
        });
        roleSelect=new Select.Combox({
            render:'#roles',
            valueField:'#roles-hide',
            store:roleStore,
            autoRender:true
        });
        userStore=new Data.Store({
            url:baseUrl+'/core/user/list',
            proxy:{
                method:'post'
            },
            autoLoad:true,
            pageSize:5
        });
        columns=[{
            title:'用户编号',dataIndex:'authid',width:100,elCls:'center'
        },{
            title:'账户名',dataIndex:'accountname',width:100,elCls:'center'
        },{
            title:'用户组',dataIndex:'rolename',width:120,elCls:'center'
        },{
            title:'当前状态',dataIndex:'valid',width:80,elCls:'center',renderer:function(value,obj){
                return obj.validflag=='Y' ? '有效' : '无效';
            }
        }];
        grid=new Grid.Grid({
            render:'#user-grid',
            width:480,
            columns:columns,
            loadMask:true,
            store:userStore,
            plugins:[Grid.Plugins.RowNumber],
            tbar:{
                items:[{
                    btnCls:'button button-small',
                    text:'<i class="icon-search"></i>搜索',
                    listeners:{
                        click:function(){
                            searchDialog.show();
                        }
                    }
                },{
                    btnCls:'button button-small',
                    text:'<i class="icon-plus-sign"></i>新增',
                    listeners:{
                        click:function(){
                            alert('A');
                        }
                    }
                },{
                    btnCls:'button button-small',
                    text:'<i class="icon-edit"></i>编辑',
                    listeners:{
                        click:function(){
                            var selection=grid.getSelected();
                            if(selection){
                                //console.log(selection.authid);
                            }else{
                                BUI.Message.Alert('请选择用户','warning');
                            }
                        }
                    }
                },{
                    btnCls:'button button-small',
                    text:'<i class="icon-user"></i>设定权限',
                    listeners:{
                        click:function(){
                            var selection=grid.getSelected();
                            if(selection){
                                //console.log(selection.authid);
                            }else{
                                BUI.Message.Alert('请选择用户','warning');
                            }
                        }
                    }
                }]
            },
            bbar:{
                pagingBar:true
            },
            autoRender:true
        });
        searchForm=new Form.HForm({
            srcNode:'#search-form'
        }).render();
        searchDialog=new Overlay.Dialog({
            title:'搜索用户',
            width:350,
            height:235,
            contentId:'user-search',
            buttons:[{
                text:'搜索',
                elCls : 'button button-primary',
                handler : function(){
                    if(searchForm.isValid()){
                        var authid=searchForm.getField('authid').get('value');
                        var accountname=searchForm.getField('accountname').get('value');
                        var rolecode=roleSelect.getSelectedValue();
                        var validflag=searchForm.getField('validflag').get('value');
                        userStore=new Data.Store({
                            url:baseUrl+'/core/user/list',
                            proxy:{
                                method:'post'
                            },
                            params:{
                                'authid':authid,
                                'accountname':accountname,
                                'rolecode':rolecode,
                                'validflag':validflag
                            },
                            pageSize:5,
                        });
                        userStore.load();
//                        userStore.on('load',function(){
//                            searchDialog.close();
//                        });
                    }
                }
            }]
        });
    });
</script>
</body>
</html>